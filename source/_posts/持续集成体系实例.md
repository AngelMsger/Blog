---
title: 持续集成体系实例
date: 2018-01-23 19:47:04
tags:
- CI
- GitLab
- Jenkins
- Docker
- DevOps
categories:
- Linux & DevOps
thumbnail: "/images/持续集成体系实例.jpg"
---
一种可行的开源持续集成体系解决方案。

# 什么是持续集成
持续集成(Continuous Integration)，简称CI，指的是不断的将开发组件集成至主干，以快速发现错误或避免长期偏离主干而造成后期集成难度过高的问题。不过一开始我们也不用理解的这么抽象，我可以说些具体的东西，比如你写好了代码，push到GitHub，有一个叫CI的东西收到了这条消息，自动的把你的代码clone到本地并尝试build，然后把结果发给你和其他关心这个项目的人。如果build成功，他们可以及时测试项目。听起来还不错吧，下面我们谈谈如何快速实现。

# 利用GitLab托管代码
要实现CI，首先要有地方托管我们的代码。对于开源项目，[GitHub](https://github.com/)或国内的替代品如[码云](https://gitee.com/)当然都是不错的选择，但是公司有很多内部项目源码并不开放且安全性要求很高，还是希望能放在自己的服务器上。GitLab就是这样的一个产品，你可以把他当作部署在自己服务器上的GitHub。搭建GitLab的步骤可以参考[GitLab Installation](https://about.gitlab.com/installation/)，不过借助Docker，这件事现在简单多了，大家可以查看[GitLab Docker images](https://docs.gitlab.com/omnibus/docker/README.html)。
{% asset_img "GitLab.png" %}

# 利用Jenkins实现持续集成
CI有很多选择，比如很多人使用的[Travis CI](https://travis-ci.org/)，因为它配置起来比较简单并且与GitHub集成的很好。不过这家伙和GitHub一样，只对开源项目免费，而对于企业中的商业项目是收费的，并且费用十分可观。就算你很有钱，支付的起这笔费用，但你的代码最终还是要交给别人，安不安全也不好说。[Jenkins](https://jenkins.io/)就是一个开源的持续集成框架，由Java实现，你可以下载War包并运行在自己的服务器上。
{% asset_img "Jenkins.png" %}
除了Jenkins外，实际上GitLab也集成了CI功能，大家可以阅读[GitLab Continuous Integration & Deployment](https://about.gitlab.com/features/gitlab-ci-cd/)了解一下，不过本文还是使用实际在企业中更常见的Jenkins。

# 与容器化一起
现在是容器化的时代了，[Docker](https://www.docker.com/)几乎成了圈子内无人不知的项目，还不了解的同学也可以看一下我的{% post_link "简谈Docker与Kubernetes" "这篇文章" %}。我们希望CI框架不仅仅是帮我自动构建，或者不仅仅是帮我执行`cmake .`，`mvn build`一类的命令，而是帮我打包成镜像，哪怕我们只是多写个Dockerfile。打包成功后最好还能帮我上传到镜像仓库([Registry](https://docs.docker.com/registry/)，类似于Docker Store的镜像收容处)去，方便以后测试和部署。当然，如果你放心的话，甚至部署也可以是自动的。

# 一次简单的实践
我们可以在本地走一遍这个流程，简单感受一下。搭建的流程在前文中提到的文档中由详述，我这里选择利用Docker。

## 环境搭建
运行GitLab，Jenkins和Docker Registry容器：
{% codeblock "运行GitLab，Jenkins和Docker Registry容器" %}
$ docker run --detach --hostname gitlab.example.com --publish 443:443 --publish 80:80 --publish 22:22 --name gitlab --restart always --volume /data/gitlab/config:/etc/gitlab --volume /data/gitlab/logs:/var/log/gitlab --volume /data/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:latest
$ docker run --name jenkins -p 8080:8080 -p 50000:50000 -v /data/jenkins:/var/jenkins_home jenkins
$ docker run -d -p 5000:5000 --restart always --name registry registry:2
{% endcodeblock %}
看起来很长，不过如果你对Docker有所了解的话，这里并没有用到什么特别的参数。有一点需要注意，像GitLab这样比较大型的项目需要比较长的初始化实践，并且是异步的，所以你命令运行完之后立即访问可能并不能看到效果，不要急于判定为容器启动失败，只是需要我们耐心等一会，你可以通过`docker logs gitlab`来查看进度。

## 完成初始配置
第一次运行这些应用，需要进行一定配置，不过都比较简单，你访问本机80端口(GitLab)和8080端口(Jenkins)，按照提示进行操作就可以了。这里需要额外注意一下，Jenkins配置好以后，需要进入 系统管理->管理插件 中安装`GitLab Plugin`插件，以与GitLab交互。

## 新建项目
这一步需要做几件事：
1. 编写一个HelloWorld程序，出于简单和易于测试，这里使用Node.js跑一个HelloWorld Web Server。
2. 编写对应的Dockerfile。
3. 在GitLab上创建项目并关联。
4. 在Jenkins上创建项目，选择自由风格的软件项目，在版本管理工具中选择Git，配置GitLab Repo URL和认证信息，确保连接正常。在下面可以配置定期构建，也可以配置为根据事件触发，比如一次普通的push，或是一次带有tag的push。同时配置构建操作，这里我们简单的写一个构建脚本，内含Docker的构建镜像和推送到我们的Docker Registry行为。

这里需要注意一下，我们配置的URL不能写127.0.0.1或localhost，因为我们是使用Docker容器的运行的，容器间彼此是隔离的，像虚拟机一样，因此GitLab无法通过127.0.0.1或localhost访问到Jenkins，Jenkins也无法通过127.0.0.1或localhost找到Docker Registry。

## 检查成果
这时我们只需要提交一次代码，应当就能触发构建。提交代码触发构建：
{% codeblock "提交代码触发构建" %}
$ git tag v1.0
$ git commit v1.0
$ git push origin master
{% endcodeblock %}
此时到Jenkins的页面查看构建进度和结果，构架完成后访问Docker Registry的REST API来查看镜像是否成功上传。
{% codeblock "" %}
$ curl http://localhost:5000/v2/_catalog
{"repositories":["node-hello-world"]}
$ curl http://localhost:5000/v2/node-hello-world/tags/list
{"name":"node-hello-world","tags":["latest"]}
{% endcodeblock %}

# 总结
持续集成/交付框架几乎是现在企业内部的必备品，能够大幅提高我们的开发效率。以上GitLab + Jenkins + Docker Registry是常见的解决方案，如果再加上容器编排工具(不了解的童鞋可以阅读{% post_link "简谈Docker与Kubernetes" "这篇文章" %})和成熟的Web整合界面(诸如管理平台或容器云平台)，使企业的开发和运维效率极大提高，解放劳动力。
