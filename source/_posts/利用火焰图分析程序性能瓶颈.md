---
title: 利用火焰图分析程序性能瓶颈
date: 2018-01-02 02:47:45
tags:
- C++
- Optimization
categories:
- C++
thumbnail: "/images/利用火焰图分析程序性能瓶颈.jpg"
---
以前入门如何提升C++程序性能的时候久仰[火焰图](https://github.com/brendangregg/FlameGraph)(FlameGraph)大名，今天又在[如何读懂火焰图？](http://www.ruanyifeng.com/blog/2017/09/flame-graph.html)里看到，便动手尝试了一番，以此记录。

# perf命令
Linux有一个小工具名叫`perf`，可以用来输出CPU调用栈相关信息，分析程序性能。

## 安装perf工具
在Arch Linux中利用Pacman安装perf工具：
{% codeblock "在Arch Linux中利用Pacman安装perf工具" %}
$ sudo pacman -S perf
{% endcodeblock %}

## 利用perf命令捕获程序运行信息
这里我们要捕获一个程序的内核态信息，因此需要root权限。频率为99Hz，捕获对象为PID是2063的进程，包括用户态和核心态，持续60s，并生成结果：
{% codeblock "频率为99Hz，捕获对象为PID是2063的进程，包括用户态和核心态，持续60s，并生成结果" %}
# perf record -F 99 -p 2063 -g -- sleep 60
# perf script > out.perf
{% endcodeblock %}
生成的结果中包含了CPU调用栈，在每个片段中运行的时间等信息。

# 利用FlameGraph工具生成火焰图
perf对于复杂程序生成的信息数据量太大且不易阅读，因此有一位大佬写了一个工具把分析结果可视化为图像，这就是火焰图FlameGraph。

## 安装FlameGraph工具
首先需要安装FlameGraph，ArchLinux如果配置了ArchLinuxCN仓库的话也可以直接利用Pacman进行安装，其他发行版可以直接从源码安装。在Arch Linux中利用Pacman安装FlameGraph工具：
{% codeblock "在Arch Linux中利用Pacman安装FlameGraph工具" %}
# sudo pacman -S flamegraph-git
{% endcodeblock %}

## 利用FlameGraph工具可视化perf结果
要生成火焰图，同样需要利用perf工具的捕获结果，因此上面一步依然是必要的。有了结果之后，还需要经过处理才能进行最后的生成。处理perf命令输出结果：
{% codeblock "处理perf命令输出结果" %}
# stackcollapse-perf.pl out.perf > out.folded
{% endcodeblock %}
经过处理后，我们就可以进入最后一步，也就是生成了。同样也是一条命令。利用处理结果生成火焰图：
{% codeblock "利用处理结果生成火焰图" %}
# flamegraph.pl out.folded > 11701.svg
{% endcodeblock %}
打开目录下生成的SVG图像，这就是火焰图了。
{% asset_img "火焰图.svg" %}

# 阅读火焰图
简单来说说通过火焰图能够看出哪些问题。火焰图纵向为调用栈，下方为父函数，上方为子函数，横向为抓取周期。因此，某一函数名横向如果越长，则CPU在此函数中停留的时间也越长，以此可以分析得到时间主要花在自身还是某一子函数中，查找性能瓶颈。在调用栈的同一层为同一函数。调用栈层次的颜色仅作区分只用，颜色深浅和运行状态并没有直接关系。

# 补充说明
除了利用perf，FlameGraph也支持利用DTrace捕获程序运行信息，以及针对Java程序的stackcollapse-jstack，针对Golang的stackcollapse-go的处理工具。大家可以参考官方文档。

# 参考资料
1. [如何读懂火焰图？](http://www.ruanyifeng.com/blog/2017/09/flame-graph.html)
2. [brendangregg/FlameGraph](https://github.com/brendangregg/FlameGraph)
