---
title: ShardingSphere核心原理
date: 2021-05-02 19:07:10
tags:
- Distributed
categories:
- Database
thumbnail: "/images/banner/ShardingSphere核心原理.jpg"
typora-root-url: ../../source/
---

# 概述

海量数据的产生带来了很多技术挑战. 目前, 关系型数据库得益于完善的生态和稳定性, 目前仍是数据平台核心业务的基石, 但单库单表的传统架构早已无法支撑互联网企业动辄日增千万的数据规模, 如何让这些数据高效的存储和访问已然是一个现实且迫切的问题. 目前, 业界普遍的做法是引入分库分表的架构, 对数据进行纵向和横向的拆分. 或使用集成类似功能的NoSQL数据库, 比如MongoDB的分片本质就是一种分表方案, 但此类数据库在可靠性等因素上与传统数据库差距很大, 并且往往在核心特性如事务上有所缺失, 据我观察较少会在公司的核心业务中使用.

分库分表的落地面临很多问题, 一方面需要对业务建模进行更精细的规划和设计, 另一方面还有实现过程的复杂性, 如如何低成本实现分片, 如何代理来自各类客户端的访问, 如何实现分布式事务和管理元数据和配置. [ShardingSphere](https://shardingsphere.apache.org/)主要解决的就是上述问题. 相比之前使用较多的[MyCat](http://www.mycat.org.cn/)或阿里开源的[Corba](https://github.com/alibaba/cobar), ShardingSphereShardingSphere虽然诞生更晚, 但设计更优秀, 开发更友好, 定制型更强, 由于不仅是Apache下该方向的第一个项目, 而且已经被当当, 京东, 哔哩哔哩等公司使用, 因此更能代表这一领域目前的技术方向, 值得深入了解.

# 分库分表

我们以MySQL举例, 虽然理论上单表可以存储过亿数据, 但根据业界普遍认同的实际经验来看, 单表数据量在超过千万量级的时候就要考虑其他方案了. 分库分表并没有标准的定义, 大致可以理解为为了解决由于数据量不断增加导致的数据库性能下降问题, 将原本独立的数据库拆分成若干数据库, 原本数据量大的表拆分成若干表, 使得单个数据库, 单张数据表的数据量控制在数据库实例能够维持性能的理想状态. 从这种表述不难理解, 分库和分表是两个独立的概念. 在这两个维度下, 又可以按照垂直和水平的拆分思路不同, 最终引出如下结构:

![拆分思路](/images/ShardingSphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E6%8B%86%E5%88%86%E6%80%9D%E8%B7%AF-9963421.png)

## 垂直拆分

所谓垂直拆分, 就是根据字段大小, 频次和热度等指标拆分到相同数据库实例内的不同表或不同数据库实例, 从而提升单表的查询性能. 比如对于用户信息, 某些基础属性如昵称的访问频率通常远高于另一些扩展属性如头像, 如果使用BLOB存储头像, 则该列还属于大字段, 进行垂直拆分可以得到一定程度的性能提升, 拆分后得到如下结构:

![用户表垂直拆分](/images/ShardingSphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E7%94%A8%E6%88%B7%E8%A1%A8%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86-9964910.png)

垂直分表后两张表仍处于相同数据库实例, 查询更简单但彼此会资源竞争. 垂直分库则相反, 两者的选择往往取决于**业务规划**和**系统边界划分**, 比如按照功能模块分库, 库中再按业务特征分表, 从而在小幅提升查询复杂度的前提下分散负载.

## 水平拆分

垂直拆表实现相对容易, 也能带来一定程度的性能提升, 但单表数据仍处于单个数据库实例中, 依然受限于单台服务器的物理资源, 所以没有解决核心问题, 因此还需要引入水平拆分, 将单表内的数据根据**一定规则**按行拆分到多个数据库实例中, 从而真正控制单表数据规模, 一些数据库也使用分片, 分区等词语表述这一行为, 但思想是一致的, 仍以用户表为例, 拆分后得到如下结构:

![用户表水平拆分](/images/ShardingSphere%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E7%94%A8%E6%88%B7%E8%A1%A8%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86.png)

其中的一定规则, 明确了任意数据应归属的表和数据库实例, 我在另一篇文章中介绍了数据库分片和一致性哈希的实现原理, 此处就不展开讨论了. 由于水平拆分后数据被分配到不同表甚至不同数据库实例中, 因此需要额外的路由工作, 在实践中, 还会存在横纵向多维度拆分的情况, 大幅提升了系统复杂度. 此时就面临如下问题:

* 如何对多个数据库实例进行高效治理?
* 如何跨实例关联查询? 如何跨表排序和分页?
* 如何保证主键的唯一性?
* 如何实现跨实例分布式事务?
* ...

上述问题如今变得即普遍又复杂, ShardingSphere等数据库中间件的诞生和核心价值就在于为上述问题提供解决方案.

# 实现方案

## 客户端分片

## Proxy

## Sidecar